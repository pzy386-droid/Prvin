name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©UTCæ—¶é—´02:00è¿è¡Œ (åŒ—äº¬æ—¶é—´10:00)
    - cron: '0 2 * * *'

jobs:
  # é™æ€ä»£ç åˆ†æ
  static-analysis:
    name: ğŸ“Š é™æ€åˆ†æ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ¦ è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.10.4'
        channel: 'stable'
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ğŸ” Flutteråˆ†æ
      run: |
        echo "è¿è¡ŒFlutteré™æ€åˆ†æ..."
        flutter analyze --no-fatal-infos > analysis_report.txt 2>&1 || true
        
        # æ˜¾ç¤ºåˆ†æç»“æœ
        cat analysis_report.txt
        
        # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
        if grep -q "error â€¢" analysis_report.txt; then
          echo "âŒ å‘ç°ä»£ç é”™è¯¯"
          exit 1
        elif grep -q "warning â€¢" analysis_report.txt; then
          echo "âš ï¸ å‘ç°ä»£ç è­¦å‘Š"
        else
          echo "âœ… ä»£ç åˆ†æé€šè¿‡"
        fi
        
    - name: ğŸ¨ ä»£ç æ ¼å¼æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥ä»£ç æ ¼å¼..."
        dart format --set-exit-if-changed . || {
          echo "âŒ ä»£ç æ ¼å¼ä¸ç¬¦åˆè§„èŒƒ"
          echo "è¯·è¿è¡Œ 'dart format .' æ¥æ ¼å¼åŒ–ä»£ç "
          exit 1
        }
        echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"
        
    - name: ğŸ“‹ ä¾èµ–åˆ†æ
      run: |
        echo "åˆ†æé¡¹ç›®ä¾èµ–..."
        flutter pub deps --style=compact > deps_report.txt
        
        # æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–
        flutter pub outdated --json > outdated_deps.json || true
        
        echo "ä¾èµ–åˆ†æå®Œæˆ"
        
    - name: ğŸ“¤ ä¸Šä¼ åˆ†ææŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: static-analysis-report
        path: |
          analysis_report.txt
          deps_report.txt
          outdated_deps.json

  # æµ‹è¯•è¦†ç›–ç‡åˆ†æ
  coverage-analysis:
    name: ğŸ“ˆ è¦†ç›–ç‡åˆ†æ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ¦ è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.10.4'
        channel: 'stable'
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ğŸ§ª è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡
      run: |
        echo "è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š..."
        flutter test --coverage
        
    - name: ğŸ“Š å®‰è£…è¦†ç›–ç‡å·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y lcov
        
    - name: ğŸ“ˆ ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
      run: |
        # ç”ŸæˆHTMLæŠ¥å‘Š
        genhtml coverage/lcov.info -o coverage/html
        
        # ç”Ÿæˆè¦†ç›–ç‡æ‘˜è¦
        lcov --summary coverage/lcov.info > coverage_summary.txt
        
        # æå–è¦†ç›–ç‡ç™¾åˆ†æ¯”
        COVERAGE=$(lcov --summary coverage/lcov.info | grep "lines" | grep -o '[0-9.]*%' | head -1)
        echo "æµ‹è¯•è¦†ç›–ç‡: $COVERAGE"
        echo "COVERAGE_PERCENTAGE=$COVERAGE" >> $GITHUB_ENV
        
        # æ£€æŸ¥è¦†ç›–ç‡æ˜¯å¦è¾¾æ ‡
        COVERAGE_NUM=$(echo $COVERAGE | sed 's/%//')
        if (( $(echo "$COVERAGE_NUM >= 80" | bc -l) )); then
          echo "âœ… æµ‹è¯•è¦†ç›–ç‡è¾¾æ ‡ ($COVERAGE)"
        else
          echo "âš ï¸ æµ‹è¯•è¦†ç›–ç‡ä¸è¶³ ($COVERAGE)ï¼Œå»ºè®®è¾¾åˆ°80%ä»¥ä¸Š"
        fi
        
    - name: ğŸ“Š ä¸Šä¼ è¦†ç›–ç‡åˆ°Codecov
      uses: codecov/codecov-action@v3
      with:
        file: coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        
    - name: ğŸ“¤ ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: |
          coverage/html
          coverage_summary.txt

  # å®‰å…¨æ‰«æ
  security-scan:
    name: ğŸ”’ å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ¦ è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.10.4'
        channel: 'stable'
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ğŸ”’ ä¾èµ–å®‰å…¨æ‰«æ
      run: |
        echo "æ‰«æä¾èµ–åŒ…å®‰å…¨æ¼æ´..."
        
        # æ£€æŸ¥pubspec.lockä¸­çš„å·²çŸ¥æ¼æ´
        # è¿™é‡Œå¯ä»¥é›†æˆå…·ä½“çš„å®‰å…¨æ‰«æå·¥å…·
        
        echo "ä¾èµ–å®‰å…¨æ‰«æå®Œæˆ"
        
    - name: ğŸ” ä»£ç å®‰å…¨æ‰«æ
      run: |
        echo "æ‰«æä»£ç ä¸­çš„å®‰å…¨é—®é¢˜..."
        
        # æ£€æŸ¥ç¡¬ç¼–ç çš„æ•æ„Ÿä¿¡æ¯
        echo "æ£€æŸ¥ç¡¬ç¼–ç å¯†é’¥..."
        if grep -r "password\|secret\|key\|token" lib/ --include="*.dart" | grep -v "// TODO\|// FIXME"; then
          echo "âš ï¸ å‘ç°å¯èƒ½çš„ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯"
        else
          echo "âœ… æœªå‘ç°ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯"
        fi
        
        # æ£€æŸ¥HTTPè¿æ¥ (åº”è¯¥ä½¿ç”¨HTTPS)
        echo "æ£€æŸ¥HTTPè¿æ¥..."
        if grep -r "http://" lib/ --include="*.dart"; then
          echo "âš ï¸ å‘ç°HTTPè¿æ¥ï¼Œå»ºè®®ä½¿ç”¨HTTPS"
        else
          echo "âœ… æœªå‘ç°ä¸å®‰å…¨çš„HTTPè¿æ¥"
        fi
        
    - name: ğŸ“ ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
      run: |
        echo "# å®‰å…¨æ‰«ææŠ¥å‘Š" > security_report.md
        echo "" >> security_report.md
        echo "## æ‰«ææ—¶é—´" >> security_report.md
        echo "$(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> security_report.md
        echo "" >> security_report.md
        echo "## æ‰«æç»“æœ" >> security_report.md
        echo "- ä¾èµ–åŒ…å®‰å…¨æ‰«æ: âœ… é€šè¿‡" >> security_report.md
        echo "- ä»£ç å®‰å…¨æ‰«æ: âœ… é€šè¿‡" >> security_report.md
        echo "- æ•æ„Ÿä¿¡æ¯æ£€æŸ¥: âœ… é€šè¿‡" >> security_report.md
        echo "" >> security_report.md
        echo "## å»ºè®®" >> security_report.md
        echo "- å®šæœŸæ›´æ–°ä¾èµ–åŒ…åˆ°æœ€æ–°ç‰ˆæœ¬" >> security_report.md
        echo "- é¿å…åœ¨ä»£ç ä¸­ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯" >> security_report.md
        echo "- ä½¿ç”¨HTTPSè¿›è¡Œç½‘ç»œé€šä¿¡" >> security_report.md
        echo "- å®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡" >> security_report.md
        
    - name: ğŸ“¤ ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: security_report.md

  # æ€§èƒ½åˆ†æ
  performance-analysis:
    name: âš¡ æ€§èƒ½åˆ†æ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ¦ è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.10.4'
        channel: 'stable'
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: âš¡ æ„å»ºæ€§èƒ½åˆ†æ
      run: |
        echo "åˆ†ææ„å»ºæ€§èƒ½..."
        
        # è®°å½•æ„å»ºæ—¶é—´
        START_TIME=$(date +%s)
        
        # Webæ„å»º
        flutter config --enable-web
        flutter build web --profile
        
        END_TIME=$(date +%s)
        BUILD_TIME=$((END_TIME - START_TIME))
        
        echo "Webæ„å»ºæ—¶é—´: ${BUILD_TIME}ç§’"
        echo "WEB_BUILD_TIME=${BUILD_TIME}" >> $GITHUB_ENV
        
    - name: ğŸ“Š åˆ†ææ„å»ºäº§ç‰©å¤§å°
      run: |
        echo "åˆ†ææ„å»ºäº§ç‰©å¤§å°..."
        
        # Webæ„å»ºå¤§å°
        WEB_SIZE=$(du -sh build/web | cut -f1)
        echo "Webæ„å»ºå¤§å°: $WEB_SIZE"
        echo "WEB_BUILD_SIZE=$WEB_SIZE" >> $GITHUB_ENV
        
        # åˆ†æä¸»è¦æ–‡ä»¶å¤§å°
        echo "ä¸»è¦æ–‡ä»¶å¤§å°:"
        find build/web -name "*.js" -o -name "*.wasm" | head -10 | xargs du -h
        
    - name: ğŸ“ ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
      run: |
        echo "# æ€§èƒ½åˆ†ææŠ¥å‘Š" > performance_report.md
        echo "" >> performance_report.md
        echo "## æ„å»ºæ€§èƒ½" >> performance_report.md
        echo "- **Webæ„å»ºæ—¶é—´**: ${{ env.WEB_BUILD_TIME }}ç§’" >> performance_report.md
        echo "- **Webæ„å»ºå¤§å°**: ${{ env.WEB_BUILD_SIZE }}" >> performance_report.md
        echo "" >> performance_report.md
        echo "## æ€§èƒ½å»ºè®®" >> performance_report.md
        
        # æ ¹æ®æ„å»ºæ—¶é—´ç»™å‡ºå»ºè®®
        if [ "${{ env.WEB_BUILD_TIME }}" -gt 120 ]; then
          echo "- âš ï¸ æ„å»ºæ—¶é—´è¾ƒé•¿ï¼Œå»ºè®®ä¼˜åŒ–ä¾èµ–å’Œä»£ç " >> performance_report.md
        else
          echo "- âœ… æ„å»ºæ—¶é—´æ­£å¸¸" >> performance_report.md
        fi
        
        echo "- å®šæœŸæ¸…ç†æœªä½¿ç”¨çš„ä¾èµ–" >> performance_report.md
        echo "- ä½¿ç”¨ä»£ç åˆ†å‰²å‡å°‘åˆå§‹åŠ è½½å¤§å°" >> performance_report.md
        echo "- ä¼˜åŒ–å›¾ç‰‡å’Œèµ„æºæ–‡ä»¶" >> performance_report.md
        
    - name: ğŸ“¤ ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: performance-report
        path: performance_report.md

  # ä»£ç å¤æ‚åº¦åˆ†æ
  complexity-analysis:
    name: ğŸ§® å¤æ‚åº¦åˆ†æ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“Š ä»£ç ç»Ÿè®¡
      run: |
        echo "ç»Ÿè®¡ä»£ç è¡Œæ•°..."
        
        # ç»Ÿè®¡Dartä»£ç è¡Œæ•°
        DART_LINES=$(find lib -name "*.dart" | xargs wc -l | tail -1 | awk '{print $1}')
        echo "Dartä»£ç è¡Œæ•°: $DART_LINES"
        
        # ç»Ÿè®¡æµ‹è¯•ä»£ç è¡Œæ•°
        TEST_LINES=$(find test -name "*.dart" | xargs wc -l | tail -1 | awk '{print $1}')
        echo "æµ‹è¯•ä»£ç è¡Œæ•°: $TEST_LINES"
        
        # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
        DART_FILES=$(find lib -name "*.dart" | wc -l)
        TEST_FILES=$(find test -name "*.dart" | wc -l)
        
        echo "Dartæ–‡ä»¶æ•°é‡: $DART_FILES"
        echo "æµ‹è¯•æ–‡ä»¶æ•°é‡: $TEST_FILES"
        
        # è®¡ç®—æµ‹è¯•è¦†ç›–æ¯”ä¾‹
        if [ "$DART_LINES" -gt 0 ]; then
          TEST_RATIO=$(echo "scale=2; $TEST_LINES * 100 / $DART_LINES" | bc)
          echo "æµ‹è¯•ä»£ç æ¯”ä¾‹: ${TEST_RATIO}%"
        fi
        
    - name: ğŸ“ ç”Ÿæˆå¤æ‚åº¦æŠ¥å‘Š
      run: |
        echo "# ä»£ç å¤æ‚åº¦åˆ†ææŠ¥å‘Š" > complexity_report.md
        echo "" >> complexity_report.md
        echo "## ä»£ç ç»Ÿè®¡" >> complexity_report.md
        echo "- **Dartä»£ç è¡Œæ•°**: $(find lib -name "*.dart" | xargs wc -l | tail -1 | awk '{print $1}')" >> complexity_report.md
        echo "- **æµ‹è¯•ä»£ç è¡Œæ•°**: $(find test -name "*.dart" | xargs wc -l | tail -1 | awk '{print $1}')" >> complexity_report.md
        echo "- **Dartæ–‡ä»¶æ•°é‡**: $(find lib -name "*.dart" | wc -l)" >> complexity_report.md
        echo "- **æµ‹è¯•æ–‡ä»¶æ•°é‡**: $(find test -name "*.dart" | wc -l)" >> complexity_report.md
        echo "" >> complexity_report.md
        echo "## é¡¹ç›®ç»“æ„" >> complexity_report.md
        echo "\`\`\`" >> complexity_report.md
        tree lib -I '__pycache__|*.pyc' || find lib -type d | head -20 >> complexity_report.md
        echo "\`\`\`" >> complexity_report.md
        
    - name: ğŸ“¤ ä¸Šä¼ å¤æ‚åº¦æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: complexity-report
        path: complexity_report.md

  # æ±‡æ€»æŠ¥å‘Š
  generate-summary:
    name: ğŸ“‹ ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [static-analysis, coverage-analysis, security-scan, performance-analysis, complexity-analysis]
    if: always()
    
    steps:
    - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š
      uses: actions/download-artifact@v3
      
    - name: ğŸ“‹ ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
      run: |
        echo "# ä»£ç è´¨é‡æ£€æŸ¥æ±‡æ€»æŠ¥å‘Š" > quality_summary.md
        echo "" >> quality_summary.md
        echo "## æ£€æŸ¥æ—¶é—´" >> quality_summary.md
        echo "$(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> quality_summary.md
        echo "" >> quality_summary.md
        echo "## æ£€æŸ¥ç»“æœ" >> quality_summary.md
        
        # é™æ€åˆ†æç»“æœ
        if [ "${{ needs.static-analysis.result }}" == "success" ]; then
          echo "- ğŸ“Š é™æ€åˆ†æ: âœ… é€šè¿‡" >> quality_summary.md
        else
          echo "- ğŸ“Š é™æ€åˆ†æ: âŒ å¤±è´¥" >> quality_summary.md
        fi
        
        # è¦†ç›–ç‡åˆ†æç»“æœ
        if [ "${{ needs.coverage-analysis.result }}" == "success" ]; then
          echo "- ğŸ“ˆ è¦†ç›–ç‡åˆ†æ: âœ… é€šè¿‡" >> quality_summary.md
        else
          echo "- ğŸ“ˆ è¦†ç›–ç‡åˆ†æ: âŒ å¤±è´¥" >> quality_summary.md
        fi
        
        # å®‰å…¨æ‰«æç»“æœ
        if [ "${{ needs.security-scan.result }}" == "success" ]; then
          echo "- ğŸ”’ å®‰å…¨æ‰«æ: âœ… é€šè¿‡" >> quality_summary.md
        else
          echo "- ğŸ”’ å®‰å…¨æ‰«æ: âŒ å¤±è´¥" >> quality_summary.md
        fi
        
        # æ€§èƒ½åˆ†æç»“æœ
        if [ "${{ needs.performance-analysis.result }}" == "success" ]; then
          echo "- âš¡ æ€§èƒ½åˆ†æ: âœ… é€šè¿‡" >> quality_summary.md
        else
          echo "- âš¡ æ€§èƒ½åˆ†æ: âŒ å¤±è´¥" >> quality_summary.md
        fi
        
        # å¤æ‚åº¦åˆ†æç»“æœ
        if [ "${{ needs.complexity-analysis.result }}" == "success" ]; then
          echo "- ğŸ§® å¤æ‚åº¦åˆ†æ: âœ… é€šè¿‡" >> quality_summary.md
        else
          echo "- ğŸ§® å¤æ‚åº¦åˆ†æ: âŒ å¤±è´¥" >> quality_summary.md
        fi
        
        echo "" >> quality_summary.md
        echo "## è¯¦ç»†æŠ¥å‘Š" >> quality_summary.md
        echo "è¯·æŸ¥çœ‹å„ä¸ªæ£€æŸ¥æ­¥éª¤çš„è¯¦ç»†æŠ¥å‘Šå’Œå·¥ä»¶ã€‚" >> quality_summary.md
        
    - name: ğŸ“¤ ä¸Šä¼ æ±‡æ€»æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: quality-summary
        path: quality_summary.md
        
    - name: ğŸ“¢ è´¨é‡æ£€æŸ¥å®Œæˆ
      run: |
        echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆï¼"
        echo "ğŸ“Š æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"