name: ğŸ“± æ„å»ºç§»åŠ¨ç«¯

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      build_android:
        description: 'æ„å»ºAndroidç‰ˆæœ¬'
        required: true
        default: true
        type: boolean
      build_ios:
        description: 'æ„å»ºiOSç‰ˆæœ¬'
        required: true
        default: false
        type: boolean

jobs:
  # Androidæ„å»º
  build-android:
    name: ğŸ¤– æ„å»ºAndroid
    runs-on: ubuntu-latest
    if: github.event.inputs.build_android == 'true' || github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: â˜• è®¾ç½®Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: ğŸ¦ è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.10.4'
        channel: 'stable'
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ğŸ§ª è¿è¡Œæµ‹è¯•
      run: flutter test
      
    - name: ğŸ”¨ æ„å»ºAPK (Release)
      run: flutter build apk --release
      
    - name: ğŸ”¨ æ„å»ºApp Bundle (Release)
      run: flutter build appbundle --release
      
    - name: ğŸ“ ç”Ÿæˆæ„å»ºä¿¡æ¯
      run: |
        mkdir -p build/android-release
        
        # å¤åˆ¶æ„å»ºäº§ç‰©
        cp build/app/outputs/flutter-apk/app-release.apk build/android-release/prvin-android.apk
        cp build/app/outputs/bundle/release/app-release.aab build/android-release/prvin-android.aab
        
        # ç”Ÿæˆæ„å»ºä¿¡æ¯
        echo "# Prvin AIæ™ºèƒ½æ—¥å† - Androidç‰ˆæœ¬" > build/android-release/BUILD_INFO.md
        echo "" >> build/android-release/BUILD_INFO.md
        echo "## æ„å»ºä¿¡æ¯" >> build/android-release/BUILD_INFO.md
        echo "- **æ„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> build/android-release/BUILD_INFO.md
        echo "- **Gitæäº¤**: ${{ github.sha }}" >> build/android-release/BUILD_INFO.md
        echo "- **Gitåˆ†æ”¯**: ${{ github.ref_name }}" >> build/android-release/BUILD_INFO.md
        echo "- **Flutterç‰ˆæœ¬**: $(flutter --version | head -n 1)" >> build/android-release/BUILD_INFO.md
        echo "- **æ„å»ºç¯å¢ƒ**: GitHub Actions" >> build/android-release/BUILD_INFO.md
        echo "" >> build/android-release/BUILD_INFO.md
        echo "## å®‰è£…è¯´æ˜" >> build/android-release/BUILD_INFO.md
        echo "### APKå®‰è£…" >> build/android-release/BUILD_INFO.md
        echo "1. ä¸‹è½½ \`prvin-android.apk\` æ–‡ä»¶" >> build/android-release/BUILD_INFO.md
        echo "2. åœ¨Androidè®¾å¤‡ä¸Šå¯ç”¨\"æœªçŸ¥æ¥æº\"å®‰è£…" >> build/android-release/BUILD_INFO.md
        echo "3. æ‰“å¼€APKæ–‡ä»¶è¿›è¡Œå®‰è£…" >> build/android-release/BUILD_INFO.md
        echo "" >> build/android-release/BUILD_INFO.md
        echo "### ç³»ç»Ÿè¦æ±‚" >> build/android-release/BUILD_INFO.md
        echo "- **Androidç‰ˆæœ¬**: 5.0 (API 21) æˆ–æ›´é«˜ç‰ˆæœ¬" >> build/android-release/BUILD_INFO.md
        echo "- **å­˜å‚¨ç©ºé—´**: è‡³å°‘50MBå¯ç”¨ç©ºé—´" >> build/android-release/BUILD_INFO.md
        echo "- **ç½‘ç»œ**: å¯é€‰ï¼Œç¦»çº¿æ¨¡å¼ä¸‹éƒ¨åˆ†åŠŸèƒ½å—é™" >> build/android-release/BUILD_INFO.md
        
        # è·å–APKä¿¡æ¯
        APK_SIZE=$(du -h build/android-release/prvin-android.apk | cut -f1)
        AAB_SIZE=$(du -h build/android-release/prvin-android.aab | cut -f1)
        
        echo "" >> build/android-release/BUILD_INFO.md
        echo "## æ–‡ä»¶ä¿¡æ¯" >> build/android-release/BUILD_INFO.md
        echo "- **APKå¤§å°**: $APK_SIZE" >> build/android-release/BUILD_INFO.md
        echo "- **AABå¤§å°**: $AAB_SIZE" >> build/android-release/BUILD_INFO.md
        
    - name: ğŸ“¤ ä¸Šä¼ Androidæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: android-release
        path: build/android-release
        retention-days: 90

  # iOSæ„å»º (ä»…åœ¨macOSä¸Šè¿è¡Œ)
  build-ios:
    name: ğŸ æ„å»ºiOS
    runs-on: macos-latest
    if: github.event.inputs.build_ios == 'true' || (github.event_name == 'push' && contains(github.ref, 'refs/tags/'))
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ¦ è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.10.4'
        channel: 'stable'
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ğŸ§ª è¿è¡Œæµ‹è¯•
      run: flutter test
      
    - name: ğŸ”¨ æ„å»ºiOS (æ— ç­¾å)
      run: flutter build ios --release --no-codesign
      
    - name: ğŸ“ ç”Ÿæˆæ„å»ºä¿¡æ¯
      run: |
        mkdir -p build/ios-release
        
        # å¤åˆ¶æ„å»ºäº§ç‰©
        cp -r build/ios/iphoneos/Runner.app build/ios-release/
        
        # ç”Ÿæˆæ„å»ºä¿¡æ¯
        echo "# Prvin AIæ™ºèƒ½æ—¥å† - iOSç‰ˆæœ¬" > build/ios-release/BUILD_INFO.md
        echo "" >> build/ios-release/BUILD_INFO.md
        echo "## æ„å»ºä¿¡æ¯" >> build/ios-release/BUILD_INFO.md
        echo "- **æ„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> build/ios-release/BUILD_INFO.md
        echo "- **Gitæäº¤**: ${{ github.sha }}" >> build/ios-release/BUILD_INFO.md
        echo "- **Gitåˆ†æ”¯**: ${{ github.ref_name }}" >> build/ios-release/BUILD_INFO.md
        echo "- **Flutterç‰ˆæœ¬**: $(flutter --version | head -n 1)" >> build/ios-release/BUILD_INFO.md
        echo "- **æ„å»ºç¯å¢ƒ**: GitHub Actions (macOS)" >> build/ios-release/BUILD_INFO.md
        echo "" >> build/ios-release/BUILD_INFO.md
        echo "## é‡è¦è¯´æ˜" >> build/ios-release/BUILD_INFO.md
        echo "âš ï¸ **æ­¤æ„å»ºæœªç­¾åï¼Œæ— æ³•ç›´æ¥å®‰è£…åˆ°è®¾å¤‡**" >> build/ios-release/BUILD_INFO.md
        echo "" >> build/ios-release/BUILD_INFO.md
        echo "### å¼€å‘è€…å®‰è£…æ­¥éª¤" >> build/ios-release/BUILD_INFO.md
        echo "1. ä¸‹è½½æ„å»ºäº§ç‰©" >> build/ios-release/BUILD_INFO.md
        echo "2. åœ¨Xcodeä¸­æ‰“å¼€é¡¹ç›®" >> build/ios-release/BUILD_INFO.md
        echo "3. é…ç½®å¼€å‘è€…è¯ä¹¦å’ŒProvisioning Profile" >> build/ios-release/BUILD_INFO.md
        echo "4. é‡æ–°æ„å»ºå¹¶å®‰è£…åˆ°è®¾å¤‡" >> build/ios-release/BUILD_INFO.md
        echo "" >> build/ios-release/BUILD_INFO.md
        echo "### App Storeå‘å¸ƒ" >> build/ios-release/BUILD_INFO.md
        echo "1. é…ç½®å‘å¸ƒè¯ä¹¦" >> build/ios-release/BUILD_INFO.md
        echo "2. ä½¿ç”¨Xcode ArchiveåŠŸèƒ½" >> build/ios-release/BUILD_INFO.md
        echo "3. ä¸Šä¼ åˆ°App Store Connect" >> build/ios-release/BUILD_INFO.md
        echo "4. æäº¤å®¡æ ¸" >> build/ios-release/BUILD_INFO.md
        echo "" >> build/ios-release/BUILD_INFO.md
        echo "## ç³»ç»Ÿè¦æ±‚" >> build/ios-release/BUILD_INFO.md
        echo "- **iOSç‰ˆæœ¬**: 11.0 æˆ–æ›´é«˜ç‰ˆæœ¬" >> build/ios-release/BUILD_INFO.md
        echo "- **è®¾å¤‡**: iPhone 6s æˆ–æ›´æ–°è®¾å¤‡" >> build/ios-release/BUILD_INFO.md
        echo "- **å­˜å‚¨ç©ºé—´**: è‡³å°‘50MBå¯ç”¨ç©ºé—´" >> build/ios-release/BUILD_INFO.md
        
    - name: ğŸ“¤ ä¸Šä¼ iOSæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: ios-release
        path: build/ios-release
        retention-days: 90

  # åˆ›å»ºç§»åŠ¨ç«¯Release
  create-mobile-release:
    name: ğŸ“¦ åˆ›å»ºç§»åŠ¨ç«¯Release
    runs-on: ubuntu-latest
    needs: [build-android]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ ä¸‹è½½Androidæ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        name: android-release
        path: android-release
        
    - name: ğŸ“¥ ä¸‹è½½iOSæ„å»ºäº§ç‰© (å¦‚æœå­˜åœ¨)
      uses: actions/download-artifact@v3
      with:
        name: ios-release
        path: ios-release
      continue-on-error: true
      
    - name: ğŸ“¦ æ‰“åŒ…æ„å»ºäº§ç‰©
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p release-packages
        
        # æ‰“åŒ…Android
        if [ -d "android-release" ]; then
          cd android-release
          zip -r ../release-packages/prvin-android-${{ github.ref_name }}.zip .
          cd ..
        fi
        
        # æ‰“åŒ…iOS (å¦‚æœå­˜åœ¨)
        if [ -d "ios-release" ]; then
          cd ios-release
          zip -r ../release-packages/prvin-ios-${{ github.ref_name }}.zip .
          cd ..
        fi
        
    - name: ğŸ“ ç”Ÿæˆç§»åŠ¨ç«¯Releaseè¯´æ˜
      run: |
        echo "# Prvin AIæ™ºèƒ½æ—¥å† ç§»åŠ¨ç«¯ ${{ github.ref_name }}" > mobile_release_notes.md
        echo "" >> mobile_release_notes.md
        echo "## ğŸ“± ç§»åŠ¨ç«¯ç‰ˆæœ¬" >> mobile_release_notes.md
        echo "" >> mobile_release_notes.md
        echo "### ğŸ¤– Androidç‰ˆæœ¬" >> mobile_release_notes.md
        echo "- **APKæ–‡ä»¶**: é€‚ç”¨äºç›´æ¥å®‰è£…" >> mobile_release_notes.md
        echo "- **ç³»ç»Ÿè¦æ±‚**: Android 5.0 (API 21) æˆ–æ›´é«˜ç‰ˆæœ¬" >> mobile_release_notes.md
        echo "- **å®‰è£…æ–¹å¼**: å¯ç”¨\"æœªçŸ¥æ¥æº\"åç›´æ¥å®‰è£…APK" >> mobile_release_notes.md
        echo "" >> mobile_release_notes.md
        
        if [ -d "ios-release" ]; then
          echo "### ğŸ iOSç‰ˆæœ¬" >> mobile_release_notes.md
          echo "- **æ„å»ºæ–‡ä»¶**: éœ€è¦å¼€å‘è€…è¯ä¹¦ç­¾å" >> mobile_release_notes.md
          echo "- **ç³»ç»Ÿè¦æ±‚**: iOS 11.0 æˆ–æ›´é«˜ç‰ˆæœ¬" >> mobile_release_notes.md
          echo "- **å®‰è£…æ–¹å¼**: éœ€è¦é€šè¿‡Xcodeæˆ–TestFlightå®‰è£…" >> mobile_release_notes.md
          echo "" >> mobile_release_notes.md
        fi
        
        echo "## ğŸš€ ä¸»è¦åŠŸèƒ½" >> mobile_release_notes.md
        echo "- ğŸ“… **æ™ºèƒ½æ—¥å†**: æœˆ/å‘¨/æ—¥è§†å›¾ï¼Œä»»åŠ¡æ‹–æ‹½ï¼Œæ—¶é—´å†²çªæ£€æµ‹" >> mobile_release_notes.md
        echo "- âœ… **ä»»åŠ¡ç®¡ç†**: å®Œæ•´CRUDæ“ä½œï¼Œæ™ºèƒ½åˆ†ç±»ï¼Œä¼˜å…ˆçº§ç®¡ç†" >> mobile_release_notes.md
        echo "- ğŸ… **ç•ªèŒ„é’Ÿ**: æ²‰æµ¸å¼è®¡æ—¶ï¼Œä¸“æ³¨ç»Ÿè®¡ï¼Œæˆå°±ç³»ç»Ÿ" >> mobile_release_notes.md
        echo "- ğŸ¤– **AIåˆ†æ**: å·¥ä½œæ¨¡å¼åˆ†æï¼Œæ•ˆç‡å»ºè®®ï¼Œæ™ºèƒ½æ¨è" >> mobile_release_notes.md
        echo "- ğŸŒ **è¯­è¨€åˆ‡æ¢**: ä¸­è‹±æ–‡ä¸€é”®åˆ‡æ¢ï¼ŒçŠ¶æ€ä¿æŒ" >> mobile_release_notes.md
        echo "- ğŸ”„ **æ•°æ®åŒæ­¥**: è·¨è®¾å¤‡åŒæ­¥ï¼Œç¦»çº¿æ”¯æŒ" >> mobile_release_notes.md
        echo "" >> mobile_release_notes.md
        echo "## ğŸ“¥ ä¸‹è½½å’Œå®‰è£…" >> mobile_release_notes.md
        echo "" >> mobile_release_notes.md
        echo "### Androidç”¨æˆ·" >> mobile_release_notes.md
        echo "1. ä¸‹è½½ \`prvin-android-${{ github.ref_name }}.zip\`" >> mobile_release_notes.md
        echo "2. è§£å‹è·å– \`prvin-android.apk\`" >> mobile_release_notes.md
        echo "3. åœ¨è®¾å¤‡è®¾ç½®ä¸­å¯ç”¨\"æœªçŸ¥æ¥æº\"å®‰è£…" >> mobile_release_notes.md
        echo "4. æ‰“å¼€APKæ–‡ä»¶è¿›è¡Œå®‰è£…" >> mobile_release_notes.md
        echo "" >> mobile_release_notes.md
        
        if [ -d "ios-release" ]; then
          echo "### iOSç”¨æˆ·" >> mobile_release_notes.md
          echo "1. ä¸‹è½½ \`prvin-ios-${{ github.ref_name }}.zip\`" >> mobile_release_notes.md
          echo "2. éœ€è¦å¼€å‘è€…è´¦æˆ·å’ŒXcodeè¿›è¡Œç­¾å" >> mobile_release_notes.md
          echo "3. æˆ–ç­‰å¾…App Storeç‰ˆæœ¬å‘å¸ƒ" >> mobile_release_notes.md
          echo "" >> mobile_release_notes.md
        fi
        
        echo "## ğŸ”§ æŠ€æœ¯ä¿¡æ¯" >> mobile_release_notes.md
        echo "- **æ„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> mobile_release_notes.md
        echo "- **Gitæäº¤**: ${{ github.sha }}" >> mobile_release_notes.md
        echo "- **Flutterç‰ˆæœ¬**: 3.10.4" >> mobile_release_notes.md
        echo "- **æœ€ä½Androidç‰ˆæœ¬**: 5.0 (API 21)" >> mobile_release_notes.md
        
        if [ -d "ios-release" ]; then
          echo "- **æœ€ä½iOSç‰ˆæœ¬**: 11.0" >> mobile_release_notes.md
        fi
        
        echo "" >> mobile_release_notes.md
        echo "## âš ï¸ é‡è¦æé†’" >> mobile_release_notes.md
        echo "- Android APKæœªåœ¨Google Playå•†åº—å‘å¸ƒï¼Œè¯·ç¡®ä¿ä»å®˜æ–¹æ¸ é“ä¸‹è½½" >> mobile_release_notes.md
        echo "- iOSç‰ˆæœ¬éœ€è¦å¼€å‘è€…è¯ä¹¦ç­¾åï¼Œå»ºè®®ç­‰å¾…App Storeç‰ˆæœ¬" >> mobile_release_notes.md
        echo "- é¦–æ¬¡å®‰è£…å¯èƒ½éœ€è¦åœ¨è®¾å¤‡è®¾ç½®ä¸­ä¿¡ä»»åº”ç”¨" >> mobile_release_notes.md
        
    - name: ğŸ·ï¸ æ›´æ–°ç°æœ‰Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Prvin AIæ™ºèƒ½æ—¥å† ${{ github.ref_name }}
        body_path: mobile_release_notes.md
        files: |
          release-packages/*
        draft: false
        prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
        append_body: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ“¢ ç§»åŠ¨ç«¯Releaseæ›´æ–°æˆåŠŸ
      run: |
        echo "âœ… ç§»åŠ¨ç«¯æ„å»ºäº§ç‰©å·²æ·»åŠ åˆ°Releaseï¼"
        echo "ğŸ·ï¸ ç‰ˆæœ¬: ${{ github.ref_name }}"
        echo "ğŸ“¦ Releaseé¡µé¢: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
        echo "ğŸ¤– Android APKå·²åŒ…å«åœ¨å‘å¸ƒä¸­"
        if [ -d "ios-release" ]; then
          echo "ğŸ iOSæ„å»ºæ–‡ä»¶å·²åŒ…å«åœ¨å‘å¸ƒä¸­"
        fi

  # é€šçŸ¥æ„å»ºå®Œæˆ
  notify-completion:
    name: ğŸ“¢ æ„å»ºå®Œæˆé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    if: always()
    
    steps:
    - name: ğŸ“Š æ„å»ºçŠ¶æ€æ±‡æ€»
      run: |
        echo "## ğŸ“± ç§»åŠ¨ç«¯æ„å»ºçŠ¶æ€æ±‡æ€»"
        echo ""
        
        # Androidæ„å»ºçŠ¶æ€
        if [ "${{ needs.build-android.result }}" == "success" ]; then
          echo "âœ… Androidæ„å»ºæˆåŠŸ"
        elif [ "${{ needs.build-android.result }}" == "skipped" ]; then
          echo "â­ï¸ Androidæ„å»ºå·²è·³è¿‡"
        else
          echo "âŒ Androidæ„å»ºå¤±è´¥"
        fi
        
        # iOSæ„å»ºçŠ¶æ€
        if [ "${{ needs.build-ios.result }}" == "success" ]; then
          echo "âœ… iOSæ„å»ºæˆåŠŸ"
        elif [ "${{ needs.build-ios.result }}" == "skipped" ]; then
          echo "â­ï¸ iOSæ„å»ºå·²è·³è¿‡"
        else
          echo "âŒ iOSæ„å»ºå¤±è´¥"
        fi
        
        echo ""
        echo "ğŸ”— æŸ¥çœ‹è¯¦ç»†æ—¥å¿—: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"