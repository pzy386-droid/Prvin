name: ğŸš€ éƒ¨ç½²Webç‰ˆæœ¬

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

# è®¾ç½®æƒé™ä»¥å…è®¸éƒ¨ç½²åˆ°GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# åªå…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²ï¼Œè·³è¿‡æ­£åœ¨è¿è¡Œçš„éƒ¨ç½²é˜Ÿåˆ—ä¸­çš„è¿è¡Œ
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æ„å»ºWebç‰ˆæœ¬
  build:
    name: ğŸ”¨ æ„å»ºWebç‰ˆæœ¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ¦ è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.10.4'
        channel: 'stable'
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ğŸ§ª è¿è¡Œæµ‹è¯•
      run: flutter test
      
    - name: ğŸŒ å¯ç”¨Webæ”¯æŒ
      run: flutter config --enable-web
      
    - name: ğŸ”¨ æ„å»ºWebå‘å¸ƒç‰ˆæœ¬
      run: flutter build web --release --web-renderer html
      
    - name: ğŸ“ åˆ›å»ºæ„å»ºä¿¡æ¯
      run: |
        echo "# Prvin AIæ™ºèƒ½æ—¥å† - Webç‰ˆæœ¬" > build/web/BUILD_INFO.md
        echo "" >> build/web/BUILD_INFO.md
        echo "## æ„å»ºä¿¡æ¯" >> build/web/BUILD_INFO.md
        echo "- **æ„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> build/web/BUILD_INFO.md
        echo "- **Gitæäº¤**: ${{ github.sha }}" >> build/web/BUILD_INFO.md
        echo "- **Gitåˆ†æ”¯**: ${{ github.ref_name }}" >> build/web/BUILD_INFO.md
        echo "- **Flutterç‰ˆæœ¬**: $(flutter --version | head -n 1)" >> build/web/BUILD_INFO.md
        echo "- **æ„å»ºç¯å¢ƒ**: GitHub Actions" >> build/web/BUILD_INFO.md
        echo "" >> build/web/BUILD_INFO.md
        echo "## è®¿é—®åœ°å€" >> build/web/BUILD_INFO.md
        echo "- **ä¸»é¡µ**: https://pzy386-droid.github.io/Prvin/" >> build/web/BUILD_INFO.md
        echo "- **ä»“åº“**: https://github.com/pzy386-droid/Prvin" >> build/web/BUILD_INFO.md
        
    - name: ğŸ“„ åˆ›å»º404é¡µé¢
      run: cp build/web/index.html build/web/404.html
      
    - name: ğŸ”§ é…ç½®GitHub Pages
      run: |
        # åˆ›å»º.nojekyllæ–‡ä»¶ä»¥ç¦ç”¨Jekyllå¤„ç†
        touch build/web/.nojekyll
        
        # åˆ›å»ºCNAMEæ–‡ä»¶ (å¦‚æœæœ‰è‡ªå®šä¹‰åŸŸå)
        # echo "your-domain.com" > build/web/CNAME
        
    - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: web-build-release
        path: build/web
        retention-days: 30
        
    - name: ğŸ”§ è®¾ç½®Pages
      uses: actions/configure-pages@v3
      
    - name: ğŸ“¤ ä¸Šä¼ åˆ°Pages
      uses: actions/upload-pages-artifact@v2
      with:
        path: build/web

  # éƒ¨ç½²åˆ°GitHub Pages
  deploy:
    name: ğŸš€ éƒ¨ç½²åˆ°GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ğŸš€ éƒ¨ç½²åˆ°GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2
      
    - name: ğŸ“¢ éƒ¨ç½²æˆåŠŸé€šçŸ¥
      run: |
        echo "âœ… Webç‰ˆæœ¬éƒ¨ç½²æˆåŠŸï¼"
        echo "ğŸŒ è®¿é—®åœ°å€: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ“± å¯ä»¥åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šå®‰è£…ä¸ºPWAåº”ç”¨"

  # æµ‹è¯•éƒ¨ç½²çš„ç½‘ç«™
  test-deployment:
    name: ğŸ§ª æµ‹è¯•éƒ¨ç½²
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
    - name: ğŸŒ æµ‹è¯•ç½‘ç«™å¯è®¿é—®æ€§
      run: |
        # ç­‰å¾…éƒ¨ç½²å®Œæˆ
        sleep 30
        
        # æµ‹è¯•ä¸»é¡µæ˜¯å¦å¯è®¿é—®
        SITE_URL="${{ needs.deploy.outputs.page_url }}"
        echo "æµ‹è¯•ç½‘ç«™: $SITE_URL"
        
        # æ£€æŸ¥HTTPçŠ¶æ€ç 
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL")
        if [ "$STATUS" -eq 200 ]; then
          echo "âœ… ç½‘ç«™å¯æ­£å¸¸è®¿é—® (HTTP $STATUS)"
        else
          echo "âŒ ç½‘ç«™è®¿é—®å¤±è´¥ (HTTP $STATUS)"
          exit 1
        fi
        
        # æ£€æŸ¥å…³é”®å†…å®¹
        CONTENT=$(curl -s "$SITE_URL")
        if echo "$CONTENT" | grep -q "Prvin"; then
          echo "âœ… ç½‘ç«™å†…å®¹æ­£å¸¸"
        else
          echo "âŒ ç½‘ç«™å†…å®¹å¼‚å¸¸"
          exit 1
        fi
        
    - name: ğŸ“± PWAåŠŸèƒ½æµ‹è¯•
      run: |
        echo "ğŸ” æ£€æŸ¥PWAé…ç½®..."
        SITE_URL="${{ needs.deploy.outputs.page_url }}"
        
        # æ£€æŸ¥manifest.json
        MANIFEST_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${SITE_URL}manifest.json")
        if [ "$MANIFEST_STATUS" -eq 200 ]; then
          echo "âœ… PWA manifestå¯è®¿é—®"
        else
          echo "âš ï¸  PWA manifestä¸å¯è®¿é—® (HTTP $MANIFEST_STATUS)"
        fi
        
        # æ£€æŸ¥service worker
        SW_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${SITE_URL}sw.js")
        if [ "$SW_STATUS" -eq 200 ]; then
          echo "âœ… Service Workerå¯è®¿é—®"
        else
          echo "âš ï¸  Service Workerä¸å¯è®¿é—® (HTTP $SW_STATUS)"
        fi

  # åˆ›å»ºGitHub Release (ä»…åœ¨æ ‡ç­¾æ¨é€æ—¶)
  create-release:
    name: ğŸ“¦ åˆ›å»ºRelease
    runs-on: ubuntu-latest
    needs: [deploy, test-deployment]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        name: web-build-release
        path: web-build
        
    - name: ğŸ“¦ æ‰“åŒ…Webç‰ˆæœ¬
      run: |
        cd web-build
        zip -r ../prvin-web-${{ github.ref_name }}.zip .
        cd ..
        
    - name: ğŸ“ ç”ŸæˆReleaseè¯´æ˜
      run: |
        echo "# Prvin AIæ™ºèƒ½æ—¥å† ${{ github.ref_name }}" > release_notes.md
        echo "" >> release_notes.md
        echo "## ğŸŒ åœ¨çº¿ä½“éªŒ" >> release_notes.md
        echo "- **Webç‰ˆæœ¬**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> release_notes.md
        echo "- **PWAå®‰è£…**: åœ¨æ”¯æŒçš„æµè§ˆå™¨ä¸­å¯ä»¥å®‰è£…ä¸ºåŸç”Ÿåº”ç”¨" >> release_notes.md
        echo "" >> release_notes.md
        echo "## ğŸ“± æ”¯æŒçš„å¹³å°" >> release_notes.md
        echo "- **Webæµè§ˆå™¨**: Chrome 88+, Firefox 85+, Safari 14+, Edge 88+" >> release_notes.md
        echo "- **ç§»åŠ¨è®¾å¤‡**: æ”¯æŒPWAå®‰è£…ï¼Œæä¾›åŸç”Ÿåº”ç”¨ä½“éªŒ" >> release_notes.md
        echo "- **æ¡Œé¢è®¾å¤‡**: æ”¯æŒé”®ç›˜å¿«æ·é”®å’Œæ¡Œé¢ç«¯ä¼˜åŒ–" >> release_notes.md
        echo "" >> release_notes.md
        echo "## ğŸš€ ä¸»è¦åŠŸèƒ½" >> release_notes.md
        echo "- ğŸ“… æ™ºèƒ½æ—¥å†ç³»ç»Ÿ - å¤šè§†å›¾æ¨¡å¼ï¼Œä»»åŠ¡å¯è§†åŒ–" >> release_notes.md
        echo "- âœ… ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ - å®Œæ•´CRUDï¼Œæ™ºèƒ½åˆ†ç±»" >> release_notes.md
        echo "- ğŸ… ç•ªèŒ„é’Ÿä¸“æ³¨æ¨¡å¼ - æ²‰æµ¸å¼è®¡æ—¶ï¼Œç»Ÿè®¡åˆ†æ" >> release_notes.md
        echo "- ğŸ¤– AIæ™ºèƒ½åˆ†æ - å·¥ä½œæ¨¡å¼åˆ†æï¼Œæ•ˆç‡å»ºè®®" >> release_notes.md
        echo "- ğŸŒ ä¸€é”®è¯­è¨€åˆ‡æ¢ - ä¸­è‹±æ–‡æ— ç¼åˆ‡æ¢" >> release_notes.md
        echo "- ğŸ”„ æ•°æ®åŒæ­¥ - è·¨è®¾å¤‡æ•°æ®åŒæ­¥" >> release_notes.md
        echo "" >> release_notes.md
        echo "## ğŸ“¥ ä¸‹è½½" >> release_notes.md
        echo "- **Webç‰ˆæœ¬**: ç›´æ¥è®¿é—®ä¸Šæ–¹é“¾æ¥ï¼Œæ— éœ€ä¸‹è½½" >> release_notes.md
        echo "- **ç¦»çº¿åŒ…**: ä¸‹è½½ä¸‹æ–¹çš„zipæ–‡ä»¶ï¼Œè§£å‹åæ‰“å¼€index.html" >> release_notes.md
        echo "" >> release_notes.md
        echo "## ğŸ”§ æŠ€æœ¯ä¿¡æ¯" >> release_notes.md
        echo "- **æ„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> release_notes.md
        echo "- **Gitæäº¤**: ${{ github.sha }}" >> release_notes.md
        echo "- **Flutterç‰ˆæœ¬**: 3.10.4" >> release_notes.md
        
    - name: ğŸ·ï¸ åˆ›å»ºRelease
      uses: softprops/action-gh-release@v1
      with:
        name: Prvin AIæ™ºèƒ½æ—¥å† ${{ github.ref_name }}
        body_path: release_notes.md
        files: |
          prvin-web-${{ github.ref_name }}.zip
        draft: false
        prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ“¢ Releaseåˆ›å»ºæˆåŠŸ
      run: |
        echo "âœ… GitHub Releaseåˆ›å»ºæˆåŠŸï¼"
        echo "ğŸ·ï¸ ç‰ˆæœ¬: ${{ github.ref_name }}"
        echo "ğŸŒ Webç‰ˆæœ¬: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo "ğŸ“¦ Releaseé¡µé¢: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"