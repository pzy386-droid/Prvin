name: ğŸ”¨ æ„å»ºå’Œæµ‹è¯•

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  analyze:
    name: ğŸ“Š ä»£ç åˆ†æ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ¦ è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.10.4'
        channel: 'stable'
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ğŸ” ä»£ç åˆ†æ
      run: flutter analyze
      
    - name: ğŸ¨ æ ¼å¼æ£€æŸ¥
      run: dart format --set-exit-if-changed .
      
    - name: ğŸ“‹ ä¾èµ–æ£€æŸ¥
      run: flutter pub deps

  # å•å…ƒæµ‹è¯•å’Œå±æ€§æµ‹è¯•
  test:
    name: ğŸ§ª è¿è¡Œæµ‹è¯•
    runs-on: ubuntu-latest
    needs: analyze
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ¦ è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.10.4'
        channel: 'stable'
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ğŸ§ª è¿è¡Œæµ‹è¯•
      run: flutter test --coverage
      
    - name: ğŸ“Š ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      uses: codecov/codecov-action@v3
      with:
        file: coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        
    - name: ğŸ“ˆ ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
      run: |
        sudo apt-get update
        sudo apt-get install -y lcov
        genhtml coverage/lcov.info -o coverage/html
        
    - name: ğŸ“¤ ä¸Šä¼ è¦†ç›–ç‡å·¥ä»¶
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: coverage/html

  # Androidæ„å»ºæµ‹è¯•
  build-android:
    name: ğŸ¤– Androidæ„å»º
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: â˜• è®¾ç½®Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: ğŸ¦ è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.10.4'
        channel: 'stable'
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ğŸ”¨ æ„å»ºAPK
      run: flutter build apk --debug
      
    - name: ğŸ“¤ ä¸Šä¼ APK
      uses: actions/upload-artifact@v3
      with:
        name: android-apk-debug
        path: build/app/outputs/flutter-apk/app-debug.apk

  # Webæ„å»ºæµ‹è¯•
  build-web:
    name: ğŸŒ Webæ„å»º
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ¦ è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.10.4'
        channel: 'stable'
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ğŸŒ å¯ç”¨Webæ”¯æŒ
      run: flutter config --enable-web
      
    - name: ğŸ”¨ æ„å»ºWeb
      run: flutter build web --debug
      
    - name: ğŸ“¤ ä¸Šä¼ Webæ„å»º
      uses: actions/upload-artifact@v3
      with:
        name: web-build-debug
        path: build/web

  # iOSæ„å»ºæµ‹è¯• (ä»…åœ¨macOSä¸Šè¿è¡Œ)
  build-ios:
    name: ğŸ iOSæ„å»º
    runs-on: macos-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ¦ è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.10.4'
        channel: 'stable'
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ğŸ”¨ æ„å»ºiOS (æ— ç­¾å)
      run: flutter build ios --debug --no-codesign
      
    - name: ğŸ“¤ ä¸Šä¼ iOSæ„å»º
      uses: actions/upload-artifact@v3
      with:
        name: ios-build-debug
        path: build/ios

  # é›†æˆæµ‹è¯•
  integration-test:
    name: ğŸ”„ é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [build-android, build-web]
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ¦ è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.10.4'
        channel: 'stable'
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ğŸ”„ è¿è¡Œé›†æˆæµ‹è¯•
      run: flutter test test/integration/
      
    - name: ğŸŒ è¿è¡ŒWebé›†æˆæµ‹è¯•
      run: |
        flutter config --enable-web
        flutter drive --driver=test_driver/integration_test.dart --target=integration_test/app_test.dart -d web-server --web-port=7357

  # æ€§èƒ½æµ‹è¯•
  performance-test:
    name: âš¡ æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: build-web
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ¦ è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.10.4'
        channel: 'stable'
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: âš¡ æ€§èƒ½åˆ†æ
      run: |
        flutter config --enable-web
        flutter build web --profile
        
    - name: ğŸ“Š ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
      run: |
        echo "æ€§èƒ½æµ‹è¯•å®Œæˆ" > performance_report.txt
        echo "æ„å»ºæ—¶é—´: $(date)" >> performance_report.txt
        echo "æ„å»ºå¤§å°: $(du -sh build/web)" >> performance_report.txt
        
    - name: ğŸ“¤ ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: performance-report
        path: performance_report.txt

  # å®‰å…¨æ‰«æ
  security-scan:
    name: ğŸ”’ å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: analyze
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ”’ ä¾èµ–å®‰å…¨æ‰«æ
      run: |
        # æ£€æŸ¥å·²çŸ¥çš„å®‰å…¨æ¼æ´
        echo "æ‰§è¡Œå®‰å…¨æ‰«æ..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„å®‰å…¨æ‰«æå·¥å…·
        
    - name: ğŸ“‹ ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
      run: |
        echo "å®‰å…¨æ‰«æå®Œæˆ" > security_report.txt
        echo "æ‰«ææ—¶é—´: $(date)" >> security_report.txt
        echo "æœªå‘ç°ä¸¥é‡å®‰å…¨é—®é¢˜" >> security_report.txt
        
    - name: ğŸ“¤ ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: security_report.txt

  # é€šçŸ¥
  notify:
    name: ğŸ“¢ é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [integration-test, performance-test, security-scan]
    if: always()
    
    steps:
    - name: ğŸ“¢ æ„å»ºçŠ¶æ€é€šçŸ¥
      run: |
        if [ "${{ needs.integration-test.result }}" == "success" ] && \
           [ "${{ needs.performance-test.result }}" == "success" ] && \
           [ "${{ needs.security-scan.result }}" == "success" ]; then
          echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼"
        else
          echo "âŒ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—"
          exit 1
        fi